{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ user.username }} Profile - Bollyfun</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #000000; 
            --bg-surface: #0a0a0a; 
            --text-main: #ffffff;
            --text-muted: #525252;
            --gradient-start: #ff0077; 
            --gradient-end: #00eaff; 
            --main-gradient: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            --watchlist-color: #ffd000;
            --finished-color: #00ff88;
            --recent-color: #ff00ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .profile-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Profile Header Card */
        .profile-card {
            background: var(--bg-surface);
            border-radius: 20px;
            padding: 50px 40px;
            margin-bottom: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 1px solid #111;
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--main-gradient);
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 40px;
        }

        /* BIG PROFILE AVATAR */
        .profile-avatar {
            width: min(280px, 80vw);
            height: min(280px, 80vw);
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--gradient-end);
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.6);
            margin-bottom: 25px;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-deep);
            border-color: var(--text-muted);
        }

        .profile-name {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--main-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-username {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 30px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: var(--bg-deep);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #111;
            transition: all 0.3s ease;
            text-align: center;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.7);
            border-color: #222;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 60px 0 30px 0;
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .section-header.watchlist-header {
            color: var(--watchlist-color);
        }

        .section-header.finished-header {
            color: var(--finished-color);
        }

        .section-header.recent-header {
            background: linear-gradient(135deg, #ff00ff, #00eaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-count {
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--text-muted);
        }

        /* Movie Grid - MATCHING INDEX.HTML STYLE */
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .movie-card {
            background: var(--bg-surface);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            height: 100%;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .movie-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.8), 0 0 15px var(--gradient-end);
            border: 1px solid var(--gradient-start);
            z-index: 2;
        }

        .movie-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            display: block;
        }

        .card-body {
            padding: 10px;
            text-align: center;
        }

        .movie-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            margin: 0;
            white-space: normal;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 2.6rem;
        }

        .status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-watchlist {
            background: var(--watchlist-color);
            color: #000;
        }

        .badge-finished {
            background: var(--finished-color);
            color: #000;
        }

        .badge-recent {
            background: linear-gradient(135deg, #ff00ff, #00eaff);
            color: #000;
        }

        /* Recent Visits Timeline */
        .recent-visits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .visit-card {
            background: var(--bg-surface);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #222;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .visit-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.8);
            border-color: var(--gradient-end);
        }

        .visit-poster {
            width: 80px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .visit-info {
            flex: 1;
        }

        .visit-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .visit-time {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: var(--bg-surface);
            border-radius: 12px;
            border: 2px dashed #222;
            margin-bottom: 40px;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--text-muted);
            margin-bottom: 20px;
            opacity: 0.4;
        }

        .empty-state h4 {
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .empty-state p {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Logout Button */
        .logout-btn {
            background: var(--main-gradient);
            color: var(--bg-deep);
            border: none;
            padding: 14px 40px;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--gradient-end);
            color: var(--bg-deep);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-name {
                font-size: 1.8rem;
            }

            .profile-username {
                font-size: 1rem;
            }

            .section-header {
                font-size: 1.5rem;
            }

            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .recent-visits-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .profile-card {
                padding: 30px 20px;
            }

            .profile-name {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>

<div class="profile-wrapper">
    <!-- Profile Card -->
    <div class="profile-card">
        <div class="profile-header">
            <!-- BIG Avatar -->
            {% if profile and profile.avatar %}
            <div class="profile-avatar">
                <img src="{{ profile.avatar.image_url }}" alt="{{ profile.avatar.name }}" title="{{ profile.avatar.name }}">
            </div>
            <button class="btn btn-sm btn-outline-info mt-3 mb-5"
        data-bs-toggle="modal"
        data-bs-target="#avatarModal">
    <i class="bi bi-pencil-square"></i> Change Avatar
</button>

            {% else %}
            <div class="profile-avatar placeholder">
                <i class="bi bi-person-circle" style="font-size: 100px; color: var(--text-muted);"></i>
            </div>
            <button class="btn btn-sm btn-outline-info mt-3 mb-5"
        data-bs-toggle="modal"
        data-bs-target="#avatarModal">
    <i class="bi bi-pencil-square"></i> Change Avatar
</button>

            {% endif %}

            <!-- User Info -->
            <div>
                <h1 class="profile-name">{{ user.first_name }} {{ user.last_name }}</h1>
                <p class="profile-username">@{{ user.username }}</p>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">
                    <i class="bi bi-envelope-fill"></i>
                    Email
                </div>
                <div class="stat-value">{{ user.email }}</div>
            </div>

            <div class="stat-item">
                <div class="stat-label">
                    <i class="bi bi-calendar-check-fill"></i>
                    Member Since
                </div>
                <div class="stat-value">{{ user.date_joined|date:"M Y" }}</div>
            </div>

            <div class="stat-item">
                <div class="stat-label">
                    <i class="bi bi-star-fill"></i>
                    Membership Expires
                </div>
                <div class="stat-value">
                    {% if profile.membership_expires_at %}
                        {{ profile.membership_expires_at|date:"M d, Y" }}
                    {% else %}
                        <span style="color: var(--text-muted);">Not Active</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Logout Button -->
        <div class="text-center">
            <a href="{% url 'logout' %}" class="logout-btn">
                <i class="bi bi-box-arrow-right"></i>
                Log Out
            </a>
        </div>
    </div>

    <!-- Recent Visits Section -->
    {% if recent_visits %}
    <div class="section-header recent-header">
        <i class="bi bi-clock-history"></i>
        Recently Visited
    </div>

    <div class="recent-visits-grid">
        {% for visit in recent_visits %}
        <a href="{% url 'movie_detail' slug=visit.movie.slug %}" class="text-decoration-none">
            <div class="visit-card">
                {% if visit.movie.dp %}
                <img src="{{ visit.movie.dp }}" alt="{{ visit.movie.title }}" class="visit-poster">
                {% else %}
                <div class="visit-poster" style="background: var(--bg-deep); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-film" style="font-size: 2rem; color: var(--text-muted);"></i>
                </div>
                {% endif %}
                <div class="visit-info">
                    <div class="visit-title">{{ visit.movie.title }}</div>
                    <div class="visit-time">
                        <i class="bi bi-clock"></i>
                        {{ visit.visited_at|timesince }} ago
                    </div>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Watchlist Section -->
    <div class="section-header watchlist-header">
        <i class="bi bi-bookmark-star-fill"></i>
        Watchlist
        <span class="section-count">({{ watchlist|length }})</span>
    </div>

    {% if watchlist %}
    <div class="movie-grid">
        {% for item in watchlist %}
        <a href="{% url 'movie_detail' slug=item.movie.slug %}" class="text-decoration-none">
            <div class="movie-card">
                <span class="status-badge badge-watchlist">
                    <i class="bi bi-bookmark-fill"></i> Watchlist
                </span>
                {% if item.movie.dp %}
                <img src="{{ item.movie.dp }}" alt="{{ item.movie.title }}" class="movie-poster" loading="lazy">
                {% else %}
                <div style="width: 100%; aspect-ratio: 2/3; background: var(--bg-deep); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-film" style="font-size: 3rem; color: var(--text-muted);"></i>
                </div>
                {% endif %}
                <div class="card-body">
                    <h4 class="movie-title">{{ item.movie.title }}</h4>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-bookmark-star"></i>
        <h4>Your Watchlist is Empty</h4>
        <p>Start adding movies you want to watch!</p>
    </div>
    {% endif %}

    <!-- Finished Section -->
    <div class="section-header finished-header">
        <i class="bi bi-check-circle-fill"></i>
        Finished
        <span class="section-count">({{ finished|length }})</span>
    </div>

    {% if finished %}
    <div class="movie-grid">
        {% for item in finished %}
        <a href="{% url 'movie_detail' slug=item.movie.slug %}" class="text-decoration-none">
            <div class="movie-card">
                <span class="status-badge badge-finished">
                    <i class="bi bi-check-circle-fill"></i> Finished
                </span>
                {% if item.movie.dp %}
                <img src="{{ item.movie.dp }}" alt="{{ item.movie.title }}" class="movie-poster" loading="lazy">
                {% else %}
                <div style="width: 100%; aspect-ratio: 2/3; background: var(--bg-deep); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-film" style="font-size: 3rem; color: var(--text-muted);"></i>
                </div>
                {% endif %}
                <div class="card-body">
                    <h4 class="movie-title">{{ item.movie.title }}</h4>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-check-circle"></i>
        <h4>No Movies Finished Yet</h4>
        <p>Movies you've completed will appear here.</p>
    </div>
    {% endif %}

</div>


<!-- Change Avatar Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" style="background:#0a0a0a; border:1px solid #222;">
      <div class="modal-header">
        <h5 class="modal-title text-white">Choose Your Avatar</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form method="POST" action="{% url 'change_avatar' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            {% for avatar in avatars %}
            <div class="col-4 col-md-3 text-center">
              <label style="cursor:pointer;">
                <input type="radio"
                       name="avatar_id"
                       value="{{ avatar.id }}"
                       hidden>
                <img src="{{ avatar.image_url }}"
                     class="img-fluid rounded-circle"
                     style="border:3px solid transparent; transition:.2s;"
                     onclick="this.style.border='3px solid #00eaff'">
              </label>
            </div>
            {% endfor %}
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">
            Save Avatar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>